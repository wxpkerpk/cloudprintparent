<!DOCTYPE HTML>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head th:include="console/header">
</head>
<body>
<section class="content-header">
    <h1>订单管理</h1>
    <small>订单列表</small>
</section>
<section class="content table-content">
    <table id="dataGrid"></table>
</section>

<div th:include="console/footer"></div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"/>

<script type="text/javascript">
    $table = $("#dataGrid");
    $(function () {
        initDataGrid();
    });
    var datePick = function (elem) {
        jQuery(elem).datepicker({dateFormat: 'yyyy-mm-dd'});
    }

    function getLocalTime(nS, row, index) {
        return new Date(parseInt(nS)).toLocaleString().replace(/:\d{1,2}$/, ' ');
    }

    function listFiles(value) {

        var files = JSON.parse(value['files'])

        var content = '<table class="table table-striped">\n'

        for (var file in files) {
            content += ('    <tr>\n' +
                '        <td>文件名称</td>\n' +
                '        <td>' + file['fileName'] + '</td>\n' +
                '    </tr>\n' +

                '        <td>打印份数</td>\n' +
                '        <td>' + file['copies'] + '</td>\n' +
                '        <td>配送号码</td>\n' +
                '        <td>' + phone + '</td>\n' +
                '    <tr>\n' +
                '        <td>价格</td>\n' +
                '        <td>' + (parseFloat(value['money']) / 100).toFixed(2) + '</td>\n' +
                '    </tr>\n')


        }

    }

    function initDataGrid() {
        $table.bootstrapTable({
            height: tableModel.getHeight(),
            idField: "id",
            columns: [[
                {
                    title: "订单日期",
                    field: "orderDate",
                    formatter: getLocalTime,
                    sorttype: "date",
                    searchable: true,
                    name: "orderDate",
                    index: "orderDate",
                    searchoptions: {dataInit: datePick, attr: {title: '选择日期'}}
                },
                {
                    title: "订单电话", field: "user.tel", search: true,
                    searchoptions: {sopt: ['eq']}
                },
                {
                    title: "价格(元)", field: "money", formatter: function (value, row, index) {

                        return (parseFloat(value) / 100).toFixed(2)
                    }
                },
                {
                    name: 'payState',
                    title: '订单状态',
                    index: 'payState',
                    width: 90,
                    editable: false,
                    search: true,
                    field: "payState",
                    searchoptions: {
                        sopt: ["eq"],
                        value: "'':全部;PAYING:正在支付;PAID:已经支付;PRINTED:已经打印;FINISH:已完成"
                    },
                    formatter: stateFormatter
                },
                {title: "详情", field: "operate3", align: 'center', events: operateEvents, formatter: detailFormatter},

                {title: "打印", field: "operate1", align: 'center', events: operateEvents, formatter: printFormatter},

                {title: "操作", field: "operate2", align: 'center', events: operateEvents, formatter: operateFormatter}
            ]],
            url: '/console/order/search',
            queryParams: function (params) {
                console.log(params)
                return params;
            },
            // responseHandler: function (res) {
            //     return {
            //         rows: res.result.pageInfo.list,
            //         total: res.result.pageInfo.total
            //     }
            // },
            sortName: 'id',
            sortOrder: 'desc',
            pagination: true,
            sidePagination: 'server',
            pageSize: 5,
            pageList: [5, 40, 50, 100],
            toolbar: "#toolbar",
            showRefresh: true,
            showToggle: true
        });
    }

    //                        value: "'':全部;PAYING:正在支付;PAID:已经支付;PRINTED:已经打印;FINISH:已完成"


    function detailFormatter(value, row, index) {
        console.log(row)
        return [
            '<a class="detail" href="javascript:void(0);" >',
            '<i class="glyphicon glyphicon-zoom-out"></i>详情',
            '</a>'
        ].join('');
    }


    function showDetail(value) {

        var name = value['dispatching'] == null ? value['user']['nickName'] : value["dispatching"]['nickname']
        var phone = value['dispatching'] == null ? value['user']['tel'] : value["dispatching"]['phone']
        var content = '<table class="table table-striped">\n' +
            '    <tr>\n' +
            '        <td>用户名字</td>\n' +
            '        <td>' + name + '</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>订单日期</td>\n' +
            '        <td>' + getLocalTime(value['orderDate']) + '</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>配送号码</td>\n' +
            '        <td>' + phone + '</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>价格</td>\n' +
            '        <td>' + (parseFloat(value['money']) / 100).toFixed(2) + '</td>\n' +
            '    </tr>\n'

        if (value['dispatching'] == null) {
            content += ('    <tr>\n' +
                '        <td >配送方式</td>' +
                '        <td>上门自取</td>' +
                '    </tr>'
            )

        } else {
            content += ('    <tr>\n' +
                '        <td >配送方式</td>' +
                '        <td>送货上门</td>' +
                '    </tr>'
            )
            content += ('    <tr>\n' +
                '        <td>配送地址</td>\n' +
                '        <td>' + value["dispatching"]['address'] + '</td>\n' +
                '    </tr>\n' +
                '    <tr>\n' +
                '        <td>配送留言</td>\n' +
                '        <td>' + value["dispatching"]['message'] + '</td>\n' +
                '    </tr>\n')
        }
        content += '</table>'

        return content

    }

    function stateFormatter(value, row, index) {
        var map = {
            "PAYING": "正在支付",
            "PAID": "已经支付",
            "PRINTED": "已经打印",
            "FINISH": "已结束"
        }
        return map[value]
    }

    function operateFormatter(value, row, index) {
        return [
            '<a class="printed" href="javascript:void(0);">',
            '<i class="glyphicon glyphicon-check"></i>已打印',
            '</a>  ',
            '<a href="/console/role/from?roleId=' + row.roleId + '" >',
            '<i class="glyphicon glyphicon-remove"></i>取消订单',
            '</a>  ',
            '<a class="remove" href="javascript:void(0);">',
            '<i class="glyphicon glyphicon-ok"></i>已经完成',
            '</a>'
        ].join('');
    }

    function printFormatter(value, row, index) {
        return [
            '<a class="print" href="javascript:void(0);" >',
            '<i class="glyphicon glyphicon-print"></i>打印',
            '</a>'
        ].join('');
    }

    window.operateEvents = {
        'click .remove': function (e, value, row, index) {
            operaModel.delRow(row.roleId, '/console/role/delete', 'roleId');
        },
        'click .print': function (e, value, row, index) {
            layer.open({
                type: 2,
                title: '角色授权',
                shadeClose: true,
                shade: false,
                maxmin: true, //开启最大化最小化按钮
                area: ['1200px', '600px'],
                content: '/console/role/grant/?roleId=' + row.roleId
            });
        },
        'click .detail': function (e, value, row, index) {
            layer.open({
                type: 1,

                title: '订单详情',
                shadeClose: true,
                shade: false,
                maxmin: true, //开启最大化最小化按钮
                area: ['500px', '500px'],
                content: showDetail(row)
            });
        }
    };

</script>
</body>
</html>

